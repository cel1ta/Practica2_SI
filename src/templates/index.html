<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Cuadro de Mando Integral</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Incluir Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        canvas {
            max-width: 600px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
<h1>Cuadro de Mando Integral</h1>

<form method="POST">
    <label for="top_x">Seleccionar Top X:</label>
    <input type="number" id="top_x" name="top_x" value="{{ top_x }}" min="1">
    <label for="show_employees">Mostrar empleados:</label>
    <input type="checkbox" id="show_employees" name="show_employees" {% if show_employees %}checked{% endif %}>
    <button type="submit">Actualizar</button>
    <button type="submit" name="generate_pdf" class="btn btn-primary">
        Descargar Informe PDF
    </button>
</form>

<h2>Top {{ top_x }} Clientes con Más Incidencias</h2>
<canvas id="clientsChart"></canvas>

<h2>Top {{ top_x }} Tipos de Incidencias por Tiempo de Resolución</h2>
<canvas id="incidentTypesChart"></canvas>

{% if show_employees and top_employees %}
<h2>Top {{ top_x }} Empleados por Tiempo Empleado</h2>
<canvas id="employeesChart"></canvas>
{% endif %}

<h2>Últimas 10 Vulnerabilidades (Tiempo Real)</h2>
{% if latest_cves %}
<table border="1">
    <tr>
        <th>CVE ID</th>
        <th>Descripción</th>
        <th>Fecha de Publicación</th>
        <th>Fecha de Actualización</th>

    </tr>
    {% for cve in latest_cves %}
    <tr>
        <td>{{ cve['cve_id'] }}</td>
        <td>{{ cve['description'] | truncate(100) }}</td>
        <td>{{ cve['published_date'] }}</td>
        <td>{{ cve['updated_date'] }}</td>

    </tr>
    {% endfor %}
</table>
{% else %}
<p>No se pudieron obtener vulnerabilidades en este momento.</p>
{% endif %}

<h2>Últimos malwares detectados</h2>

{% if latest_malware %}
<table class="table-auto w-full border-collapse">
    <thead>
    <tr class="bg-gray-200">
        <th class="px-4 py-2 border">SHA256</th>
        <th class="px-4 py-2 border">Nombre de Archivo</th>
        <th class="px-4 py-2 border">Tipo de Archivo</th>
        <th class="px-4 py-2 border">Firma</th>
        <th class="px-4 py-2 border">Etiquetas</th>
        <th class="px-4 py-2 border">Primera Detección</th>
    </tr>
    </thead>
    <tbody>
    {% for last in latest_malware %}
    <tr class="hover:bg-gray-100">
        <td class="px-4 py-2 border breaking-all">{{ last.sha256 }}</td>
        <td class="px-4 py-2 border">{{ last.file_name }}</td>
        <td class="px-4 py-2 border">{{ last.file_type }}</td>
        <td class="px-4 py-2 border">{{ last.signature }}</td>
        <td class="px-4 py-2 border">
            {% if last.tags %}
            {{ last.tags | join(', ') }}
            {% else %}
            —
            {% endif %}
        </td>
        <td class="px-4 py-2 border">{{ last.first_seen[:10] }}</td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p>No se pudieron obtener malwares en este momento.</p>
{% endif %}


<script>
    // Datos para el gráfico de barras (Top Clientes)
    const clientsData = {
        labels: [{% for client in top_clients %}'{{ client['cliente'] }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        label: 'Número de Incidencias',
        data: [{% for client in top_clients %}{{ client['incident_count'] }}{% if not loop.last %},{% endif %}{% endfor %}],
    backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
    }]
    };

    // Configuración del gráfico de barras (Clientes)
    const clientsChart = new Chart(document.getElementById('clientsChart'), {
        type: 'bar',
        data: clientsData,
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Número de Incidencias'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'ID Cliente'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });

    // Datos para el gráfico de líneas (Top Tipos de Incidencias)
    const incidentTypesData = {
        labels: [{% for incident in top_incident_types %}'{{ incident['tipo_incidencia'] }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        label: 'Tiempo Promedio de Resolución (Días)',
        data: [{% for incident in top_incident_types %}{{ incident['avg_resolution_days'] | round(2) }}{% if not loop.last %},{% endif %}{% endfor %}],
    fill: false,
        borderColor: 'rgba(255, 99, 132, 1)',
        tension: 0.1
    }]
    };

    // Configuración del gráfico de líneas (Tipos de Incidencias)
    const incidentTypesChart = new Chart(document.getElementById('incidentTypesChart'), {
        type: 'line',
        data: incidentTypesData,
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Tiempo Promedio (Días)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Tipo de Incidencia'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });

    // Datos para el gráfico de barras (Top Empleados)
    {% if show_employees and top_employees %}
    const employeesData = {
        labels: [{% for employee in top_employees %}'{{ employee['id_emp'] }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        label: 'Tiempo Total (Horas)',
        data: [{% for employee in top_employees %}{{ employee['total_time'] | round(2) }}{% if not loop.last %},{% endif %}{% endfor %}],
    backgroundColor: 'rgba(75, 192, 192, 0.6)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1
    }]
    };

    // Configuración del gráfico de barras (Empleados)
    const employeesChart = new Chart(document.getElementById('employeesChart'), {
        type: 'bar',
        data: employeesData,
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Tiempo Total (Horas)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'ID Empleado'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });
    {% endif %}
</script>
</body>
</html>
